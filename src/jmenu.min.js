import eye from"eyeejs";const hmNoop=()=>{};let btnsCounter=0;const templates={separator:eye("model:jmenu-menu-item separator",{"<span>: _label":{}}),normal:eye("model:jmenu-menu-item",{"<div>.p1":{},"<div>.p2":{"<div>: _label":{},"<div>: _accelerator":{}},"<div>.p3":{}})};class JmenuEvent extends CustomEvent{#e=null;#t=null;constructor(e,t,s){super(e,{bubbles:!1,cancelable:!1}),this.#e=t,this.#t=s}get menu(){return this.#e}get which(){return this.#t}}class JButton{#s=!0;value=null;constructor(e,t){this.menu=e,this.button=null,this.label=t.label||"New Button "+ ++btnsCounter,this.func=t.func||hmNoop,this.type=t.type||"button",this.icon=t.icon,this.accelerator=t.accelerator||null,this.properties=t,this.runtime={},this.#i()}#i(){const e=this.menu.props.spacing;let t=this;if("separator"==this.type)this.button=templates.separator({parent:this.menu.elm,_label:this.label});else{let s=this.button=templates.normal({parent:this.menu.elm,_label:this.label,_accelerator:this.accelerator}),i=s.child(0),n=s.child(1),l=s.child(2),o=Array.isArray(e)?e[0]:e,r=Array.isArray(e)?e[1]:e;i.css("width",`${o}px`).css("backgroundImage",this.icon?`url(${this.icon})`:""),l.css("width",`${r}px`);let a=n.child(0),u=n.child(1),h=null,c=null,p=null,d=null,m=null;switch(this.type){case"button":c=function(e){!1!==t.func(t,e)&&t.menu.close(!0)};break;case"check-box":let e=Array.isArray(this.label)?this.label:[this.label,this.label];a.text(e[0]);let o=eye("<div>",{class:"jmenu-check-box-mark"});this.runtime.checkBoxMark=o,this.selected=!1,c=function(){!0===t.selected?(t.selected=!1,o.remove(),n.child(0).text(e[0])):(t.selected=!0,i.append(o),n.child(0).text(e[1])),!1!==t.func(t.selected,t)&&t.menu.close()};break;case"radio-button":if(!this.properties.name)throw new Error("[JmenuJS] Error:\n Radio boxes buttons definition must contain name attribute!");this.menu.radios[this.properties.name]||(this.menu.radios[this.properties.name]={ball:eye("<div>",{class:"jmenu-radio-button-mark"})},i.append(this.menu.radios[this.properties.name].ball)),!0===this.properties.default&&i.append(this.menu.radios[this.properties.name].ball),c=function(){let e=t.menu.radios[t.properties.name];e.ball&&i.append(e.ball),!1!==t.func(t.label,t)&&t.menu.close()};break;case"definition":let r=eye("<div>",{class:"jmenu-definition-box",parent:document.body,html:this.properties.def},{display:"none"});this.runtime.defBloc=r,u.text("definition"),p=function(){let e=this.getBoundingClientRect(),t=e.left+e.width+5,s=e.top;window.innerWidth-(e.left+e.width)<200&&(t=e.left-205),r.css("left",`${t}px`).css("top",`${s}px`).css("display","inline-block")},d=()=>r.css("display","none");break;case"slider":let b=this.properties.format=this.properties.format||"_value_",f=this.properties.step=this.properties.step||1,g=this.properties.range=this.properties.range||[0,100];s.class("+jmenu-slider"),u.class("+jmenu-slider-btns");let y=eye("<div>",{class:"jmenu-slider-btn"});u.append(y);let v=eye("<div>",{class:"jmenu-slider-show"});u.append(v);let w=eye("<div>",{class:"jmenu-slider-btn"});u.append(w);eye("<div>",{class:"jmenu-minus",parent:y}),eye("<div>",{class:"jmenu-plus1",parent:w}),eye("<div>",{class:"jmenu-plus2",parent:w});this.value=this.properties.default||g[0],v.text(b.replace("_value_",this.value)),y.click((function(){t.#s&&(t.value=Math.max(t.value-f,g[0]),v.text(b.replace("_value_",t.value)),t.func(t.value,t))})),w.click((function(){t.#s&&(t.value=Math.min(t.value+f,g[1]),v.text(b.replace("_value_",t.value)),t.func(t.value,t))})),!0===this.properties.wheel&&(m=function(e){e.preventDefault(),e.deltaY>=0?y.click():w.click()});break;case"submenu":u.class("+jmenu-menu-item-arrow"),h=new Jmenu(this.properties.submenu,{action:"none",parent:this.menu,alignToTarget:"left",alignToOffset:2}),this.menu.submenus.push(h),p=function(){this.tm=setTimeout((function(){let e=l.compute();h.popup({x:e.left+e.width-3,y:e.top},s.raw)}),500)},d=function(){this.tm&&clearTimeout(this.tm)}}"function"==typeof c&&s.click((e=>{t.#s&&c(e)})),"function"==typeof p&&s.mouseenter(p),"function"==typeof d&&s.mouseleave(d),"function"==typeof m&&s.on("wheel",m),s.mouseenter((function(){for(let e=0;e<t.menu.submenus.length;e++)t.menu.submenus[e].close()})),this.properties.disabled&&this.disable()}}setValue(e){"slider"==this.type&&"number"==typeof e&&(this.value=e<this.properties.range[0]?this.properties.range[0]:e>this.properties.range[1]?this.properties.range[1]:e,this.button.child(1).child(1).child(1).text(this.properties.format.replace("_value_",this.value)))}enable(){this.#s=!0,this.button.attr("style",!1)}disable(){this.#s=!1,this.button.css("background-color","transparent").css("color","gray").css("pointer-action","none").css("cursor","default")}}class Jmenu{def=null;props={};elm=null;target=window;#n=[];#l=null;radios={};submenus=[];computed={menuHeight:0,menuWidth:0,parent:null};untouchable=null;#o={};constructor(e,t){this.def=e,t||(t={});let{target:s=window,action:i="contextmenu",bars:n=5,spacing:l=30,parent:o=null,alignToTarget:r=null,alignToOffset:a=0}=t,u=this;this.target=s??window,this.computed.parent=o,this.props={target:s,action:i,bars:n,spacing:l,alignToTarget:r,alignToOffset:a},o?this.untouchable=o.untouchable:(this.untouchable=eye("<div>",{class:"jmenu-untouchable",parent:document.body}),this.untouchable.mousedown((function(){u.close()}))),this.create(),this.bindEvents(),this.#r()}get which(){return this.#l}bindEvents(){let e=(this.props.action??"contextmenu").split(" "),t=this;e.forEach((e=>{"string"==typeof t.target?window.addEventListener(e,(function(e){e.target.closest(t.target)&&(e.preventDefault(),t.popup({x:e.clientX,y:e.clientY},e.target))})):t.target.addEventListener(e,(function(e){e.preventDefault(),t.popup({x:e.clientX,y:e.clientY},e.target)}))}))}create(){let e=eye("<div>",{class:["jmenu-menu","unselect"],parent:document.body}),t=this;this.elm=e;let s=0,i=0;"number"==typeof this.props.bars?s=i=this.props.bars:Array.isArray(this.props.bars)&&(s=this.props.bars[0],i=this.props.bars[1]),e.css("padding-top",s+"px"),e.css("padding-bottom",i+"px"),this.elm.css("display","none"),this.def.forEach((e=>{t.addButton(e)}))}addButton(e){let t=new JButton(this,e);this.#n.push(t)}get buttons(){return this.#n}popup(e,t){let{x:s,y:i}=e,n=this.props.alignToTarget;if(this.#l=t,[!0,"left","right"].includes(n)){let e=this.props.alignToOffset,l=t.getBoundingClientRect();[!0,"left"].includes(n)&&l.left+l.width+this.computed.menuWidth>window.innerWidth?n="right":"right"==n&&l.left-this.computed.menuWidth<0&&(n="left"),"left"===n||!0===n?s=l.left+l.width+2-e:"right"===n&&(s=l.left-this.computed.menuWidth-2+e),i=l.top+this.computed.menuHeight>window.innerHeight?l.top+l.height-this.computed.menuHeight:l.top}else i+this.computed.menuHeight>window.innerHeight-20&&(i=window.innerHeight-(20+this.computed.menuHeight)),s+this.computed.menuWidth>window.innerWidth-20&&(s=window.innerWidth-(20+this.computed.menuWidth));this.elm.css("left",s+"px"),this.elm.css("top",i+"px"),this.elm.css("position","fixed"),this.elm.css("display","inline-block"),this.untouchable&&this.untouchable.show("inline-block"),this.trigger("open",new JmenuEvent("open",this,t))}close(e){if(e&&this.computed.parent)return this.computed.parent.close(!0);0!=this.submenus.length&&this.submenus.forEach((e=>e.close())),this.elm.css("display","none"),this.computed.parent||this.untouchable.hide(),this.trigger("close",new JmenuEvent("close",this,window))}#r(){this.elm.css("left",-9999),this.elm.css("position","fixed"),this.elm.css("display","inline-block");let e=this.elm.compute();this.computed.menuHeight=e.height,this.computed.menuWidth=e.width,this.elm.css("display","none")}hideButton(e){this.#n[e]&&this.#n[e].button.hide()}showButton(e){this.#n[e]&&this.#n[e].button.show("flex")}enableButton(e){this.#n[e]&&this.#n[e].enable()}disableButton(e){this.#n[e]&&this.#n[e].disable()}setButtonProp(e,t,s){if(this.buttons[e]){let i=this.buttons[e];switch(t){case"label":i.label=s,i.button.refresh({default:!1,_label:s});break;case"value":i.setValue(s);break;case"icon":"separator"!=i.type&&i.button.child(0).css("backgroundImage",s);break;case"accelerator":["slider","separator","definition"].includes(i.type)||i.button.refresh({default:!1,_accelerator:s});break;case"definition":"definition"==i.type&&i.runtime.defBloc.html(i.properties.def=s)}}}on(e,t){Array.isArray(this.#o[e])||(this.#o[e]=[]),this.#o[e].push(t)}off(e,t){if(Array.isArray(this.#o[e])){let s=this.#o[e].findIndex((e=>t===e));-1!=s&&this.#o[e].splice(s,1)}}trigger(e,...t){let s=this;Array.isArray(this.#o[e])&&this.#o[e].forEach((e=>e.call(s,...t)))}}console.warn("[JmenuJS] Don't forget to link the css file bundled with the library to get full functional menus!");export default Jmenu;